name: vcpkg Package Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-vcpkg-installation:
    name: Test vcpkg Installation (${{ matrix.os }}-${{ matrix.triplet }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux targets
          - os: ubuntu-latest
            triplet: x64-linux
          - os: ubuntu-latest
            triplet: x64-linux-dynamic
          - os: ubuntu-latest
            triplet: arm64-linux
          
          # Windows targets
          - os: windows-latest
            triplet: x64-windows
          - os: windows-latest
            triplet: x64-windows-static
          - os: windows-latest
            triplet: x86-windows
          - os: windows-latest
            triplet: arm64-windows
          
          # macOS targets
          - os: macos-latest
            triplet: x64-osx
          - os: macos-latest
            triplet: arm64-osx

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clone vcpkg repository
      shell: bash
      run: |
        git clone https://github.com/microsoft/vcpkg.git ${{ github.workspace }}/vcpkg
        cd ${{ github.workspace }}/vcpkg

    - name: Bootstrap vcpkg (Unix)
      if: runner.os != 'Windows'
      run: ${{ github.workspace }}/vcpkg/bootstrap-vcpkg.sh

    - name: Bootstrap vcpkg (Windows)
      if: runner.os == 'Windows'
      run: ${{ github.workspace }}/vcpkg/bootstrap-vcpkg.bat

    - name: Copy local port to vcpkg ports directory
      shell: bash
      run: |
        mkdir -p ${{ github.workspace }}/vcpkg/ports/neko-schema
        cp -r ${{ github.workspace }}/packages/vcpkg/neko-schema/* ${{ github.workspace }}/vcpkg/ports/neko-schema/

    - name: Update portfile to use local source
      shell: bash
      run: |
        cat > ${{ github.workspace }}/vcpkg/ports/neko-schema/portfile.cmake << 'EOF'
        set(SOURCE_PATH "$ENV{GITHUB_WORKSPACE}")

        vcpkg_cmake_configure(
            SOURCE_PATH "${SOURCE_PATH}"
            OPTIONS
                -DNEKO_SCHEMA_BUILD_TESTS=OFF
                -DNEKO_SCHEMA_AUTO_FETCH_DEPS=OFF
                -DNEKO_SCHEMA_ENABLE_MODULE=OFF
        )

        vcpkg_cmake_install()
        vcpkg_cmake_config_fixup(CONFIG_PATH lib/cmake/NekoSchema)

        file(REMOVE_RECURSE "${CURRENT_PACKAGES_DIR}/debug")
        file(REMOVE_RECURSE "${CURRENT_PACKAGES_DIR}/lib")

        vcpkg_install_copyright(FILE_LIST "${SOURCE_PATH}/LICENSE")

        file(INSTALL "${CMAKE_CURRENT_LIST_DIR}/usage" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}")
        EOF

    - name: Install neko-schema via vcpkg (Unix)
      if: runner.os != 'Windows'
      run: |
        ${{ github.workspace }}/vcpkg/vcpkg install neko-schema:${{ matrix.triplet }}

    - name: Install neko-schema via vcpkg (Windows)
      if: runner.os == 'Windows'
      run: |
        ${{ github.workspace }}/vcpkg/vcpkg.exe install neko-schema:${{ matrix.triplet }}

    - name: Verify installation structure
      shell: bash
      run: |
        echo "=== Verifying vcpkg installation structure ==="
        
        INSTALL_ROOT="${{ github.workspace }}/vcpkg/installed/${{ matrix.triplet }}"
        
        # Check headers
        if [ -d "$INSTALL_ROOT/include/neko/schema" ]; then
          echo "✓ Headers directory exists"
          echo "  Headers found:"
          find "$INSTALL_ROOT/include/neko/schema" -type f
        else
          echo "✗ Headers directory not found"
          exit 1
        fi
        
        # Check CMake config
        if [ -f "$INSTALL_ROOT/share/neko-schema/NekoSchemaConfig.cmake" ]; then
          echo "✓ CMake config file exists"
        else
          echo "✗ CMake config file not found"
          exit 1
        fi
        
        # Check copyright/license
        if [ -f "$INSTALL_ROOT/share/neko-schema/copyright" ]; then
          echo "✓ Copyright file exists"
        else
          echo "✗ Copyright file not found"
          exit 1
        fi
        
        # Check usage file
        if [ -f "$INSTALL_ROOT/share/neko-schema/usage" ]; then
          echo "✓ Usage file exists"
          echo "  Usage content:"
          cat "$INSTALL_ROOT/share/neko-schema/usage"
        else
          echo "✗ Usage file not found"
          exit 1
        fi
        
        # Verify no debug or lib directories (header-only library)
        if [ -d "$INSTALL_ROOT/debug" ]; then
          echo "✗ Debug directory should not exist for header-only library"
          exit 1
        else
          echo "✓ No debug directory (correct for header-only)"
        fi
        
        if [ -d "$INSTALL_ROOT/lib" ]; then
          echo "✗ Lib directory should not exist for header-only library"
          exit 1
        else
          echo "✓ No lib directory (correct for header-only)"
        fi
        
        echo ""
        echo "=== All installation checks passed! ==="
